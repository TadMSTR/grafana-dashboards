# Telegraf Configuration for Unraid â†’ InfluxDB
# 
# This configuration collects comprehensive metrics from Unraid including:
# - CPU, memory, disk usage
# - Disk I/O statistics
# - SMART drive health data
# - Network statistics
# - System load and uptime
# - UPS monitoring (via apcupsd)
# - Temperature sensors
#
# Deploy this config to: /mnt/user/appdata/telegraf/telegraf.conf

###############################################################################
#                            GLOBAL AGENT SETTINGS                            #
###############################################################################

[agent]
  ## Default data collection interval for all inputs
  interval = "60s"
  
  ## Rounds collection interval to 'interval'
  round_interval = true
  
  ## Telegraf will send metrics to outputs in batches
  metric_batch_size = 1000
  
  ## Maximum number of unwritten metrics per output
  metric_buffer_limit = 10000
  
  ## Collection jitter is used to jitter the collection by a random amount
  collection_jitter = "0s"
  
  ## Default flushing interval for all outputs
  flush_interval = "10s"
  flush_jitter = "0s"
  
  ## Precision for timestamps (0s = nanosecond)
  precision = "0s"
  
  ## Override default hostname
  hostname = "unraid"
  
  ## If set to true, do not set the "host" tag in the telegraf agent
  omit_hostname = false

###############################################################################
#                            OUTPUT PLUGINS                                   #
###############################################################################

# Output to InfluxDB v2
[[outputs.influxdb_v2]]
  ## The URLs of the InfluxDB cluster nodes
  ## 
  ## If InfluxDB is running on Unraid: use http://UNRAID-IP:8086
  ## If InfluxDB is on another server: use http://SERVER-IP:8086
  urls = ["http://YOUR_INFLUXDB_URL:8086"]
  
  ## Token for authentication
  ## Get this from InfluxDB web UI after setup
  token = "YOUR_INFLUXDB_TOKEN_HERE"
  
  ## Organization is the name of the organization you wish to write to
  organization = "homelab"
  
  ## Destination bucket to write into
  bucket = "unraid"
  
  ## Timeout for HTTP messages
  timeout = "5s"

###############################################################################
#                            INPUT PLUGINS                                    #
###############################################################################

# System CPU metrics
[[inputs.cpu]]
  ## Whether to report per-cpu stats or not
  percpu = true
  
  ## Whether to report total system cpu stats or not
  totalcpu = true
  
  ## If true, collect raw CPU time metrics
  collect_cpu_time = false
  
  ## If true, compute and report the sum of all non-idle CPU states
  report_active = false

# Memory metrics
[[inputs.mem]]
  # No configuration needed

# Disk usage metrics
[[inputs.disk]]
  ## Ignore mount points by filesystem type
  ignore_fs = ["tmpfs", "devtmpfs", "devfs", "iso9660", "overlay", "aufs", "squashfs"]
  
  ## Include specific mount points
  ## Adjust these paths based on your Unraid array configuration
  mount_points = [
    "/mnt/user",      # Main Unraid user share
    "/mnt/cache",     # Cache drive/pool
    "/mnt/datastor",  # Additional pools (if you have them)
    "/mnt/disk1",     # Individual array disks
    "/mnt/disk2",
    "/mnt/disk3",
    "/mnt/disk4",
    "/mnt/disk5",
    "/mnt/disk6",
    "/mnt/disk7",
    "/mnt/disk8",
    "/mnt/disk9",
    "/mnt/disk10",
    "/mnt/disk11",
    "/mnt/disk12",
    "/mnt/disk13",
    "/mnt/disk14",
    "/mnt/disk15",
    "/mnt/disk16",
    "/mnt/disk17",
    "/mnt/disk18",
    "/mnt/disk19",
    "/mnt/disk20"
  ]

# Disk I/O metrics
[[inputs.diskio]]
  ## Devices to monitor (all physical drives)
  ## This will capture all SATA/SAS (sd*) and NVMe (nvme*) drives
  devices = ["sd*", "nvme*"]

# System load and uptime
[[inputs.system]]
  # No configuration needed

# Network statistics
[[inputs.net]]
  ## Network interfaces to monitor
  ## Common Unraid interfaces: eth0, br0
  ## Adjust based on your network configuration
  interfaces = ["eth0", "br0"]

# Docker container metrics (OPTIONAL)
# Uncomment if you want per-container monitoring
# Note: This can significantly increase data volume with many containers
#
#[[inputs.docker]]
#  ## Docker Endpoint
#  endpoint = "unix:///var/run/docker.sock"
#  
#  ## Containers to include/exclude
#  container_name_include = []
#  container_name_exclude = []
#  
#  ## Timeout for docker commands
#  timeout = "5s"

# SMART disk health metrics
[[inputs.smart]]
  ## Path to smartctl executable (in Telegraf container)
  path_smartctl = "/usr/sbin/smartctl"
  
  ## Optionally specify devices to monitor
  ## Leave commented to auto-detect all drives
  ## Uncomment and customize if you want to monitor specific drives only
#  devices = [
#    "/dev/sda",
#    "/dev/sdb",
#    "/dev/sdc",
#    # ... add more drives as needed
#  ]
  
  ## Use sudo for smartctl
  ## Set to false if running as root (typical in Docker)
  use_sudo = true
  
  ## Timeout for smartctl commands
  timeout = "30s"
  
  ## Gather all SMART attributes
  attributes = true

# Temperature sensors (if available via lm-sensors)
[[inputs.temp]]
  # Auto-detects available temperature sensors

# Process statistics
[[inputs.processes]]
  # No configuration needed

# APC UPS monitoring (OPTIONAL)
# Only enable if you have a UPS connected via apcupsd
# Install apcupsd from Unraid Community Applications first
#
[[inputs.apcupsd]]
  ## A list of running apcupsd server to connect to
  ## Default connects to localhost
  servers = ["tcp://127.0.0.1:3551"]
  
  ## Timeout for apcupsd commands
  timeout = "5s"

###############################################################################
#                            CONFIGURATION NOTES                              #
###############################################################################

# IMPORTANT TELEGRAF CONTAINER SETTINGS:
#
# The Telegraf container MUST be configured with these settings:
#
# 1. PRIVILEGED MODE: Required for SMART data access
#    - Enable "Privileged" in container settings
#
# 2. VOLUME MOUNTS:
#    - Config: /mnt/user/appdata/telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro
#    - Host FS: /:/hostfs:ro
#    - Proc: /proc:/host/proc:ro
#    - Sys: /sys:/host/sys:ro
#    - Docker: /var/run/docker.sock:/var/run/docker.sock:ro (if monitoring Docker)
#    - Devices: /dev:/dev:ro
#
# 3. ENVIRONMENT VARIABLES:
#    - HOST_PROC=/host/proc
#    - HOST_SYS=/host/sys
#    - HOST_MOUNT_PREFIX=/hostfs
#
# 4. NETWORK MODE: host (recommended for accurate network stats)
#
# CUSTOMIZATION:
#
# - Adjust mount_points in [[inputs.disk]] to match your disk configuration
# - Modify interfaces in [[inputs.net]] for your network setup
# - Enable Docker monitoring if needed (increases data volume)
# - Disable UPS monitoring if you don't have apcupsd
# - Change collection interval if needed (default 60s is recommended)
#
# VERIFICATION:
#
# After deploying, check Telegraf logs:
#   docker logs telegraf
#
# Verify metrics in InfluxDB Data Explorer:
#   - Measurements: cpu, mem, disk, diskio, smart_device, system, net
#   - Should see data within 1-2 minutes of Telegraf startup
#
# TROUBLESHOOTING:
#
# - "Permission denied" errors: Enable privileged mode
# - No SMART data: Check /dev:/dev:ro mount and privileged mode
# - No disk metrics: Verify HOST_MOUNT_PREFIX=/hostfs environment variable
# - No network data: Check network mode is set to "host"
# - Connection errors: Verify InfluxDB URL and token are correct
#
###############################################################################
